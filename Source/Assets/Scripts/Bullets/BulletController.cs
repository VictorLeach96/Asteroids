using UnityEngine;
using System.Collections;

public class BulletController : MonoBehaviour
{
	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Properties
	////////////////////////////////////////////////////////////////////////////////////////////////////

	Rigidbody2D m_rigidBody;
	ObjectPool m_bulletPool;
	ObjectPool m_bulletExplosionPool;
	public float moveSpeed = 10f;

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Setup
	////////////////////////////////////////////////////////////////////////////////////////////////////

	void Awake()
	{
		m_rigidBody = (Rigidbody2D)GetComponent<Rigidbody2D>();
		m_bulletPool = (ObjectPool)GameObject.FindGameObjectWithTag("BulletPool").GetComponent<ObjectPool>();
		m_bulletExplosionPool = (ObjectPool)GameObject.FindGameObjectWithTag("BulletExplosionPool").GetComponent<ObjectPool>();
	}

	void Start()
	{
		FireBullet();
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Event Listeners
	////////////////////////////////////////////////////////////////////////////////////////////////////

	void OnBecameInvisible()
	{
		m_bulletPool.RecycleObjectInPool(gameObject);
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Collision
	////////////////////////////////////////////////////////////////////////////////////////////////////

	void OnCollisionEnter2D(Collision2D collision)
	{
		//Explode this bullet once its collided with a wall
		if (collision.gameObject.tag == "Walls")
		{
			ExplodeBullet();
		}
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////
	// Methods
	////////////////////////////////////////////////////////////////////////////////////////////////////

	//Fire the bullet at given speed
	public void FireBullet()
	{
		m_rigidBody.velocity = Vector2.right * moveSpeed;
	}

	//Trigger the bullet explosion effect
	public void ExplodeBullet()
	{
		//Create particle effect for bullet explosion at this position
		GameObject particlesEmitter = m_bulletExplosionPool.InstantiateNextAvailableObject();
		particlesEmitter.transform.position = transform.position;
		
		//Recycle the bullet once explosion effect is playing
		m_bulletPool.RecycleObjectInPool(gameObject);
	}
}
